import u,{Fragment as W,createContext as q,useContext as U,useEffect as v,useMemo as z,useRef as C,useState as j}from"react";import{Features as de,forwardRefWithAs as k,render as J,RenderStrategy as T}from"../../utils/render.js";import{OpenClosedProvider as fe,State as P,useOpenClosed as K}from"../../internal/open-closed.js";import{match as V}from"../../utils/match.js";import{microTask as Te}from"../../utils/micro-task.js";import{useId as pe}from"../../hooks/use-id.js";import{useIsMounted as me}from"../../hooks/use-is-mounted.js";import{useIsoMorphicEffect as ce}from"../../hooks/use-iso-morphic-effect.js";import{useLatestValue as I}from"../../hooks/use-latest-value.js";import{useServerHandoffComplete as Q}from"../../hooks/use-server-handoff-complete.js";import{useSyncRefs as X}from"../../hooks/use-sync-refs.js";import{useTransition as he}from"../../hooks/use-transition.js";import{useEvent as Y}from"../../hooks/use-event.js";function m(e=""){return e.split(" ").filter(n=>n.trim().length>1)}let N=q(null);N.displayName="TransitionContext";var ge=(t=>(t.Visible="visible",t.Hidden="hidden",t))(ge||{});function ve(){let e=U(N);if(e===null)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return e}function Ce(){let e=U(R);if(e===null)throw new Error("A <Transition.Child /> is used but it is missing a parent <Transition /> or <Transition.Root />.");return e}let R=q(null);R.displayName="NestingContext";function L(e){return"children"in e?L(e.children):e.current.filter(({state:n})=>n==="visible").length>0}function Z(e){let n=I(e),t=C([]),r=me(),i=Y((o,l=T.Hidden)=>{let s=t.current.findIndex(({id:d})=>d===o);s!==-1&&(V(l,{[T.Unmount](){t.current.splice(s,1)},[T.Hidden](){t.current[s].state="hidden"}}),Te(()=>{var d;!L(t)&&r.current&&((d=n.current)==null||d.call(n))}))}),c=Y(o=>{let l=t.current.find(({id:s})=>s===o);return l?l.state!=="visible"&&(l.state="visible"):t.current.push({id:o,state:"visible"}),()=>i(o,T.Unmount)});return z(()=>({children:t,register:c,unregister:i}),[c,i,t])}function be(){}let Se=["beforeEnter","afterEnter","beforeLeave","afterLeave"];function $(e){var t;let n={};for(let r of Se)n[r]=(t=e[r])!=null?t:be;return n}function Ee(e){let n=C($(e));return v(()=>{n.current=$(e)},[e]),n}let xe="div",ee=de.RenderStrategy,te=k(function(n,t){let{beforeEnter:r,afterEnter:i,beforeLeave:c,afterLeave:o,enter:l,enterFrom:s,enterTo:d,entered:b,leave:S,leaveFrom:E,leaveTo:A,...p}=n,h=C(null),x=X(h,t),[f,D]=j("visible"),F=p.unmount?T.Unmount:T.Hidden,{show:g,appear:re,initial:ne}=ve(),{register:y,unregister:H}=Ce(),w=C(null),a=pe();v(()=>{if(!!a)return y(a)},[y,a]),v(()=>{if(F===T.Hidden&&!!a){if(g&&f!=="visible"){D("visible");return}V(f,{["hidden"]:()=>H(a),["visible"]:()=>y(a)})}},[f,a,y,H,g,F]);let ie=I({enter:m(l),enterFrom:m(s),enterTo:m(d),entered:m(b),leave:m(S),leaveFrom:m(E),leaveTo:m(A)}),se=Ee({beforeEnter:r,afterEnter:i,beforeLeave:c,afterLeave:o}),O=Q();v(()=>{if(O&&f==="visible"&&h.current===null)throw new Error("Did you forget to passthrough the `ref` to the actual DOM node?")},[h,f,O]);let M=ne&&!re,oe=(()=>!O||M||w.current===g?"idle":g?"enter":"leave")(),_=C(!1),B=Z(()=>{_.current||(D("hidden"),H(a))});he({container:h,classes:ie,events:se,direction:oe,onStart:I(()=>{_.current=!0}),onStop:I(ue=>{_.current=!1,ue==="leave"&&!L(B)&&(D("hidden"),H(a))})}),v(()=>{!M||(F===T.Hidden?w.current=null:w.current=g)},[g,M,f]);let le=p,ae={ref:x};return u.createElement(R.Provider,{value:B},u.createElement(fe,{value:V(f,{["visible"]:P.Open,["hidden"]:P.Closed})},J({ourProps:ae,theirProps:le,defaultTag:xe,features:ee,visible:f==="visible",name:"Transition.Child"})))}),G=k(function(n,t){let{show:r,appear:i=!1,unmount:c,...o}=n,l=X(t);Q();let s=K();if(r===void 0&&s!==null&&(r=V(s,{[P.Open]:!0,[P.Closed]:!1})),![!0,!1].includes(r))throw new Error("A <Transition /> is used but it is missing a `show={true | false}` prop.");let[d,b]=j(r?"visible":"hidden"),S=Z(()=>{b("hidden")}),[E,A]=j(!0),p=C([r]);ce(()=>{E!==!1&&p.current[p.current.length-1]!==r&&(p.current.push(r),A(!1))},[p,r]);let h=z(()=>({show:r,appear:i,initial:E}),[r,i,E]);v(()=>{r?b("visible"):L(S)||b("hidden")},[r,S]);let x={unmount:c};return u.createElement(R.Provider,{value:S},u.createElement(N.Provider,{value:h},J({ourProps:{...x,as:W,children:u.createElement(te,{ref:l,...x,...o})},theirProps:{},defaultTag:W,features:ee,visible:d==="visible",name:"Transition"})))}),ye=k(function(n,t){let r=U(N)!==null,i=K()!==null;return u.createElement(u.Fragment,null,!r&&i?u.createElement(G,{ref:t,...n}):u.createElement(te,{ref:t,...n}))}),We=Object.assign(G,{Child:ye,Root:G});export{We as Transition};
